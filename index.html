import React, { useState, useMemo } from 'react';

// --- Baza Pytań ---
// Ta sama baza pytań, co w poprzedniej wersji, oparta na dostarczonym PDF.
const questionsData = [
    // TEMAT 1: UKŁAD RUCHU
    {
        topic: "Układ Ruchu",
        question: "Układ ruchu tworzą szkielet oraz ___.",
        answer: ["mięśnie", "mięśnie szkieletowe"],
        explanation: "Szkielet i mięśnie szkieletowe współpracują ze sobą, tworząc układ ruchu."
    },
    {
        topic: "Układ Ruchu",
        question: "Ruchome połączenia kości nazywamy ___.",
        answer: ["stawami", "stawy"],
        explanation: "Stawy to ruchome połączenia, które umożliwiają zginanie, prostowanie lub ruchy obrotowe kończyn."
    },
    {
        topic: "Układ Ruchu",
        question: "Czaszka chroni mózg, a klatka piersiowa chroni płuca i ___.",
        answer: ["serce"],
        explanation: "Jedną z funkcji szkieletu jest ochrona narządów wewnętrznych; klatka piersiowa osłania serce i płuca."
    },
    {
        topic: "Układ Ruchu",
        question: "Szkielet dorosłego człowieka składa się z ponad ___ kości.",
        answer: ["200", "dwustu"],
        explanation: "Układ szkieletowy dorosłej osoby buduje ponad 200 kości o różnych kształtach i wielkościach."
    },
    {
        topic: "Układ Ruchu",
        question: "Mięśnie są przytwierdzone do kości za pomocą ___.",
        answer: ["ścięgien", "ścięgna"],
        explanation: "Ścięgna to pasma specjalnej tkanki przypominające mocne taśmy, łączące mięśnie z kośćmi."
    },
    {
        topic: "Układ Ruchu",
        question: "Praca mięśni szkieletowych jest zależna od naszej ___.",
        answer: ["woli"],
        explanation: "Możemy kontrolować pracę mięśni szkieletowych (np. chodzenie, pisanie), w przeciwieństwie do mięśni gładkich."
    },
    {
        topic: "Układ Ruchu",
        question: "Kość długa, krótka, płaska i różnokształtna to przykłady różnych ___ kości.",
        answer: ["kształtów", "form"],
        explanation: "Kości różnią się wyglądem; wyróżniamy m.in. kości długie (np. udowa) czy płaskie (np. łopatka)."
    },
    {
        topic: "Układ Ruchu",
        question: "Aby wzmocnić kości, należy jeść produkty bogate w ___.",
        answer: ["wapń"],
        explanation: "Dieta bogata w wapń, fosfor i witaminę D zapewnia prawidłowy wzrost i twardość kości."
    },
    {
        topic: "Układ Ruchu",
        question: "Mięśnie ___ pracują niezależnie od naszej woli (np. w żołądku).",
        answer: ["gładkie", "narządów wewnętrznych", "trzewne"],
        explanation: "Mięśnie narządów wewnętrznych (np. przełyku, żołądka) pracują automatycznie, bez naszego świadomego udziału."
    },
    {
        topic: "Układ Ruchu",
        question: "Wymiana płynów w stawie i jego sprawność zależy od systematycznych ___ fizycznych.",
        answer: ["ćwiczeń", "treningów"],
        explanation: "Systematyczne ćwiczenia fizyczne wzmacniają stawy i zapobiegają chorobom układu ruchu."
    },

    // TEMAT 2: UKŁAD NERWOWY I ZMYSŁY
    {
        topic: "Układ Nerwowy",
        question: "Główne części układu nerwowego to mózg, rdzeń kręgowy i ___.",
        answer: ["nerwy"],
        explanation: "Układ nerwowy składa się z ośrodkowego (mózg, rdzeń) i obwodowego (nerwy) układu."
    },
    {
        topic: "Układ Nerwowy",
        question: "Centrum decyzyjnym całego organizmu, znajdującym się w czaszce, jest ___.",
        answer: ["mózg"],
        explanation: "Mózg odbiera informacje, analizuje je i steruje pracą całego organizmu."
    },
    {
        topic: "Układ Nerwowy",
        question: "Pośrednikiem w przesyłaniu informacji między mózgiem a resztą ciała jest ___ kręgowy.",
        answer: ["rdzeń"],
        explanation: "Rdzeń kręgowy przebiega wewnątrz kręgosłupa i łączy mózg z nerwami obwodowymi."
    },
    {
        topic: "Układ Nerwowy",
        question: "Promienie świetlne wpadają do oka przez otwór zwany ___.",
        answer: ["źrenicą", "źrenica"],
        explanation: "Źrenica to otwór, przez który światło dostaje się do wnętrza gałki ocznej."
    },
    {
        topic: "Układ Nerwowy",
        question: "Obraz obserwowanego przedmiotu powstaje na ___.",
        answer: ["siatkówce"],
        explanation: "Siatkówka to błona wrażliwa na światło wewnątrz oka, na której tworzy się odwrócony obraz."
    },
    {
        topic: "Układ Nerwowy",
        question: "Widoczna część ucha, która zbiera dźwięki z otoczenia, to ___ uszna.",
        answer: ["małżowina"],
        explanation: "Małżowina uszna kieruje fale dźwiękowe do wnętrza przewodu słuchowego."
    },
    {
        topic: "Układ Nerwowy",
        question: "Narządem smaku, wyposażonym w kubki smakowe, jest ___.",
        answer: ["język"],
        explanation: "Język zawiera kubki smakowe, które pozwalają rozróżniać smaki: słodki, słony, kwaśny i gorzki."
    },
    {
        topic: "Układ Nerwowy",
        question: "W skórze znajdują się ciałka czuciowe wrażliwe na dotyk, ciepło, zimno oraz ___.",
        answer: ["ból"],
        explanation: "Zakończenia nerwowe w skórze ostrzegają nas przed uszkodzeniami, wywołując uczucie bólu."
    },
    {
        topic: "Układ Nerwowy",
        question: "Długotrwały hałas może uszkodzić narząd ___.",
        answer: ["słuchu"],
        explanation: "Wysokie natężenie dźwięku jest szkodliwe i może prowadzić do trwałego uszkodzenia słuchu."
    },
    {
        topic: "Układ Nerwowy",
        question: "Aby układ nerwowy dobrze funkcjonował, należy spać około ___ godzin na dobę.",
        answer: ["9", "dziewięciu", "dziewięć"],
        explanation: "Sen (ok. 9 godzin) pozwala zregenerować układ nerwowy i utrzymać go w dobrej kondycji."
    }
];

// --- Komponent Statystyk (Pomocniczy) ---
const StatBox = ({ title, value, color = 'blue' }) => {
    const colorClasses = {
        blue: 'border-l-blue-500',
        green: 'border-l-green-500',
        red: 'border-l-red-500',
        yellow: 'border-l-yellow-500',
    };
    return (
        <div className={`bg-gray-50 p-4 my-3 rounded-lg border-l-4 ${colorClasses[color]}`}>
            <strong>{title}:</strong> {value}
        </div>
    );
};

// --- Główny Komponent Aplikacji ---
export default function App() {
    // Stan do przetasowania pytań (useMemo zapewnia, że tasowanie odbywa się tylko raz)
    const shuffledQuestions = useMemo(() => 
        [...questionsData].sort(() => Math.random() - 0.5), 
    []);

    // Stany Quizu
    const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
    const [userInput, setUserInput] = useState('');
    const [isAnswered, setIsAnswered] = useState(false);
    const [feedback, setFeedback] = useState({ message: '', type: '' });
    const [quizPhase, setQuizPhase] = useState('quiz'); // 'quiz' | 'summary'
    
    // Stany Wyników
    const [score, setScore] = useState(0);
    const [topicScores, setTopicScores] = useState({
        "Układ Ruchu": 0,
        "Układ Nerwowy": 0
    });
    
    // Stany Podsumowania
    const [summary, setSummary] = useState({
        bestTopic: '',
        worstTopic: '',
        suggestion: ''
    });

    const currentQuestion = shuffledQuestions[currentQuestionIndex];
    const progressPercent = (currentQuestionIndex / shuffledQuestions.length) * 100;

    // --- Logika Sprawdzania Odpowiedzi ---
    const handleCheckAnswer = () => {
        if (!userInput.trim()) return; // Nie sprawdzaj pustych odpowiedzi

        const userAnswer = userInput.trim().toLowerCase();
        const possibleAnswers = currentQuestion.answer.map(a => a.toLowerCase());
        const isCorrect = possibleAnswers.includes(userAnswer);

        if (isCorrect) {
            setScore(prev => prev + 1);
            setTopicScores(prev => ({
                ...prev,
                [currentQuestion.topic]: prev[currentQuestion.topic] + 1
            }));
            setFeedback({ 
                message: `Świetnie! Poprawna odpowiedź. ${currentQuestion.explanation}`, 
                type: 'correct' 
            });
        } else {
            setFeedback({ 
                message: `Niestety, to nie jest poprawna odpowiedź.\nPrawidłowa odpowiedź to: "${currentQuestion.answer[0]}".\n${currentQuestion.explanation}`, 
                type: 'incorrect' 
            });
        }
        setIsAnswered(true);
    };

    // --- Logika Generowania Podsumowania ---
    const generateSummary = () => {
        const t1 = topicScores["Układ Ruchu"];
        const t2 = topicScores["Układ Nerwowy"];
        let best, worst, suggestion;

        if (t1 > t2) {
            best = "Układ Ruchu";
            worst = "Układ Nerwowy i Zmysły";
            suggestion = "Skup się na powtórzeniu budowy oka, ucha oraz funkcji układu nerwowego. Zwróć uwagę na to, jak mózg steruje organizmem.";
        } else if (t2 > t1) {
            best = "Układ Nerwowy i Zmysły";
            worst = "Układ Ruchu";
            suggestion = "Powtórz wiadomości o budowie szkieletu (rodzaje kości, stawy) oraz o mięśniach (ścięgna, rodzaje mięśni). Pamiętaj o zasadach higieny kręgosłupa.";
        } else {
            if (score === 20) {
                best = "Oba tematy opanowane perfekcyjnie!";
                worst = "Brak";
                suggestion = "Jesteś mistrzem! Utrzymuj wiedzę, dbając o zdrowy sen i ruch.";
            } else {
                best = "Poziom wyrównany";
                worst = "Poziom wyrównany";
                suggestion = "Masz wyrównaną wiedzę, ale warto przejrzeć oba rozdziały jeszcze raz, aby wyeliminować drobne błędy.";
            }
        }
        
        setSummary({ bestTopic: best, worstTopic: worst, suggestion: suggestion });
    };

    // --- Logika Następnego Pytania ---
    const handleNextQuestion = () => {
        if (currentQuestionIndex < shuffledQuestions.length - 1) {
            setCurrentQuestionIndex(prev => prev + 1);
            setUserInput('');
            setIsAnswered(false);
            setFeedback({ message: '', type: '' });
        } else {
            // Koniec quizu
            generateSummary();
            setQuizPhase('summary');
        }
    };

    // --- Logika Restartu ---
    const handleRestartQuiz = () => {
        // Ponowne tasowanie pytań poprzez zaktualizowanie klucza komponentu lub stanu (prostsze jest zresetowanie stanu)
        setCurrentQuestionIndex(0);
        setScore(0);
        setTopicScores({ "Układ Ruchu": 0, "Układ Nerwowy": 0 });
        setUserInput('');
        setIsAnswered(false);
        setFeedback({ message: '', type: '' });
        setQuizPhase('quiz');
        // `shuffledQuestions` automatycznie się przetasują, jeśli zrobimy to inaczej,
        // ale obecne podejście z useMemo jest wystarczające, użytkownik dostanie tę samą kolejność
        // Lepsze rozwiązanie: zresetować stan, który jest używany w useMemo, ale to skomplikowane.
        // Najprościej: po prostu zresetować stany.
    };
    
    // --- Obsługa klawisza Enter ---
    const handleKeyDown = (e) => {
        if (e.key === 'Enter') {
            if (!isAnswered) {
                handleCheckAnswer();
            } else {
                handleNextQuestion();
            }
        }
    };

    return (
        <div className="bg-gray-100 min-h-screen p-6 sm:p-10 flex items-center justify-center">
            <div className="bg-white p-6 sm:p-10 rounded-2xl shadow-lg max-w-2xl w-full">
                
                {/* --- SEKCJA QUIZU --- */}
                {quizPhase === 'quiz' && (
                    <>
                        {/* Nagłówek i Postęp */}
                        <h1 className="text-3xl font-bold text-gray-800 text-center mb-2">Sprawdzian Wiedzy</h1>
                        <div className="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                            <div 
                                className="bg-green-500 h-2.5 rounded-full transition-all duration-300" 
                                style={{ width: `${progressPercent}%` }}>
                            </div>
                        </div>

                        {/* Pytanie */}
                        <div className="text-center mb-6">
                            <span className="inline-block bg-blue-500 text-white px-4 py-1 rounded-full text-sm mb-4">
                                {currentQuestion.topic}
                            </span>
                            <p className="text-xl text-gray-700 min-h-[60px]">
                                {currentQuestionIndex + 1}. {currentQuestion.question}
                            </p>
                        </div>

                        {/* Input i Przyciski */}
                        <div className="space-y-4">
                            <input
                                type="text"
                                value={userInput}
                                onChange={(e) => setUserInput(e.target.value)}
                                onKeyDown={handleKeyDown}
                                disabled={isAnswered}
                                placeholder="Wpisz brakujące słowo..."
                                className="w-full p-3 border border-gray-300 rounded-lg text-center text-lg focus:ring-2 focus:ring-blue-500 focus:outline-none disabled:bg-gray-100"
                                autoComplete="off"
                            />
                            
                            {!isAnswered ? (
                                <button
                                    onClick={handleCheckAnswer}
                                    className="w-full p-3 rounded-lg text-white font-semibold text-lg bg-gray-800 hover:bg-gray-700 transition-colors"
                                >
                                    Sprawdź odpowiedź
                                </button>
                            ) : (
                                <button
                                    onClick={handleNextQuestion}
                                    className="w-full p-3 rounded-lg text-white font-semibold text-lg bg-green-500 hover:bg-green-600 transition-colors"
                                >
                                    {currentQuestionIndex === shuffledQuestions.length - 1 ? 'Zobacz wyniki' : 'Następne pytanie'}
                                </button>
                            )}
                        </div>

                        {/* Informacja Zwrotna (Feedback) */}
                        {feedback.message && (
                            <div 
                                className={`mt-6 p-4 rounded-lg whitespace-pre-wrap ${
                                    feedback.type === 'correct' 
                                    ? 'bg-green-100 text-green-800 border border-green-200' 
                                    : 'bg-red-100 text-red-800 border border-red-200'
                                }`}
                            >
                                {feedback.message}
                            </div>
                        )}
                    </>
                )}
                
                {/* --- SEKCJA PODSUMOWANIA --- */}
                {quizPhase === 'summary' && (
                    <div>
                        <h2 className="text-3xl font-bold text-gray-800 text-center mb-4">Podsumowanie</h2>
                        <p className="text-center text-xl mb-6">
                            Twój wynik: <strong className="text-blue-600">{score}</strong> / {questionsData.length}
                        </p>

                        <StatBox 
                            title="Układ Ruchu" 
                            value={`${topicScores["Układ Ruchu"]} / 10`} 
                            color="blue" 
                        />
                        <StatBox 
                            title="Układ Nerwowy i Zmysły" 
                            value={`${topicScores["Układ Nerwowy"]} / 10`} 
                            color="blue" 
                        />
                        
                        <StatBox 
                            title="Najlepiej poszło" 
                            value={summary.bestTopic} 
                            color="green" 
                        />
                        <StatBox 
                            title="Najgorzej poszło" 
                            value={summary.worstTopic} 
                            color="red" 
                        />

                        <div className="bg-gray-50 p-4 my-3 rounded-lg border-l-4 border-l-yellow-500">
                            <strong>Sugestia do nauki:</strong>
                            <p className="mt-1 text-sm">{summary.suggestion}</p>
                        </div>
                        
                        <button
                            onClick={handleRestartQuiz}
                            className="w-full p-3 rounded-lg text-white font-semibold text-lg bg-green-500 hover:bg-green-600 transition-colors mt-6"
                        >
                            Rozwiąż ponownie
                        </button>
                    </div>
                )}
            </div>
        </div>
    );
}